function load_game(){var e={score:score,lives:lives,level:level};$.ajax({url:"loadgame",type:"POST",data:e,success:function(e){var t=JSON.parse(e);if(t.gameover){paused_game=!0,fundal.stop(),$("#GameOver").modal("show");var a=document.createTextNode(t.gameover);document.getElementById("gamescore").appendChild(a)}else maze=t.maze,ghosts=t.friends,player_image=t.player_image,PIXI.loader.add(["./gfx/line.jpg","./gfx/corner.jpg","./gfx/corner-inner.jpg","./gfx/pill.png","./gfx/pill_bonus.png"]).load(setup)},error:function(){}})}function next_level(){(eaten_pills==container_pill.children.length||0==lives)&&(level++,PIXI.loader.reset(),paused_game=!0,fundal.stop(),alarm.stop(),load_game())}function setup(){paused_game=!1,gametimer=3*fps,sound_intro.play(),ghosts[0].sprite=PIXI.Sprite.fromImage(ghosts[0].url),ghosts[1].sprite=PIXI.Sprite.fromImage(ghosts[1].url),ghosts[2].sprite=PIXI.Sprite.fromImage(ghosts[2].url),ghosts[3].sprite=PIXI.Sprite.fromImage(ghosts[3].url),player=PIXI.Sprite.fromImage(player_image),player.x=232,player.y=256,player.vx=-1,player.vy=0,player.width=40,player.height=70,player.timer=0;for(var e=0;4>e;e++)ghosts[e].sprite.x=player.x,ghosts[e].sprite.y=player.y-64,ghosts[e].state="STATE_NONE",ghosts[e].dir="DIR_NONE",ghosts[e].die=!1,ghosts[e].startx=16*(16-e),ghosts[e].starty=208,ghosts[e].startTimer=fps*(3*e+2);ghosts[0].scatter_timer=8,ghosts[0].scared_timer=8,ghosts[0].chase_timer=20,ghosts[1].scatter_timer=8,ghosts[1].scared_timer=8,ghosts[1].chase_timer=20,ghosts[2].scatter_timer=8,ghosts[2].scared_timer=8,ghosts[2].chase_timer=20,ghosts[3].scatter_timer=8,ghosts[3].scared_timer=8,ghosts[3].chase_timer=20,player_dir=LEFT,player_last_dir=LEFT,eaten_pills=0;var t=keyboard(37),a=keyboard(38),r=keyboard(39),s=keyboard(40);t.press=function(){player_dir=LEFT},r.press=function(){player_dir=RIGHT},a.press=function(){player_dir=UP},s.press=function(){player_dir=DOWN},container_pill=new PIXI.Container;for(var i=!1,o=!1,p=!1,n=!1,e=0;e<maze.h;e++)for(var l=0;l<maze.w;l++)if(0!=maze.map[e][l]){if(16==e&&19>l&&l>10)continue;var h,m,d=!1;h=new PIXI.Sprite(resources["./gfx/pill.png"].texture),m=new PIXI.Sprite(resources["./gfx/pill_bonus.png"].texture);var f=16*l+8,c=16*e+8;4==l&&10>e&&e>3&&0==i?(i=!0,d=!0):l==maze.w-5&&10>e&&e>3&&0==o?(o=!0,d=!0):4==l&&28>e&&e>21&&0==p?(p=!0,d=!0):l==maze.w-5&&28>e&&e>21&&0==n&&(n=!0,d=!0),1==d?(m.width=24,m.height=24,m.x=f-m.width/2,m.y=c-m.width/2,pills_bonus.push(m),m.visible=!0,container_pill.addChild(m)):(h.width=6,h.height=6,h.x=f-h.width/2,h.y=c-h.width/2,h.visible=!0,container_pill.addChild(h))}for(var e=stage.children.length-1;e>=0;e--)stage.removeChild(stage.children[e]);graphics=new PIXI.Graphics,ghosts[0].mask=new PIXI.Graphics,ghosts[1].mask=new PIXI.Graphics,ghosts[2].mask=new PIXI.Graphics,ghosts[3].mask=new PIXI.Graphics,container=new PIXI.Container,container.filters=[mazefilter],stage.addChild(container),stage.addChild(container_pill),stage.addChild(player),stage.addChild(graphics),stage.addChild(ghosts[0].sprite),stage.addChild(ghosts[0].mask),stage.addChild(ghosts[1].sprite),stage.addChild(ghosts[1].mask),stage.addChild(ghosts[2].sprite),stage.addChild(ghosts[2].mask),stage.addChild(ghosts[3].sprite),stage.addChild(ghosts[3].mask),stage.addChild(scoretext),stage.addChild(leveltext),stage.addChild(starttext),ghosts[0].sprite.filters=[filter1],ghosts[1].sprite.filters=[filter2],ghosts[2].sprite.filters=[filter3],ghosts[3].sprite.filters=[filter4],player.mask=graphics,ghosts[0].sprite.mask=ghosts[0].mask,ghosts[1].sprite.mask=ghosts[1].mask,ghosts[2].sprite.mask=ghosts[2].mask,ghosts[3].sprite.mask=ghosts[3].mask;for(var u={1:{src:"./gfx/line.jpg",rot:180},16:{src:"./gfx/line.jpg",rot:0},64:{src:"./gfx/line.jpg",rot:90},4:{src:"./gfx/line.jpg",rot:270},65:{src:"./gfx/corner.jpg",rot:270},5:{src:"./gfx/corner.jpg",rot:0},80:{src:"./gfx/corner.jpg",rot:180},20:{src:"./gfx/corner.jpg",rot:90},2:{src:"./gfx/corner-inner.jpg",rot:180},8:{src:"./gfx/corner-inner.jpg",rot:270},32:{src:"./gfx/corner-inner.jpg",rot:0},128:{src:"./gfx/corner-inner.jpg",rot:90}},e=0;e<maze.h;e++)for(var l=0;l<maze.w;l++)if(0==maze.map[e][l]){var y=0,g=0;0==l?(e>0&&(y|=maze.map[e-1][l],g|=maze.map[e-1][l+1]<<1),y|=maze.map[e][l+1]<<2,e<maze.h-1&&(g|=maze.map[e+1][l+1]<<3,y|=maze.map[e+1][l]<<4)):l==maze.w-1&&(e>0&&(y|=maze.map[e-1][l],g|=maze.map[e-1][l-1]<<7),y|=maze.map[e][l-1]<<6,e<maze.h-1&&(y|=maze.map[e+1][l]<<4,g|=maze.map[e+1][l-1]<<5)),0==e?(l>0&&(g|=maze.map[e+1][l-1]<<5,y|=maze.map[e][l-1]<<6),y|=maze.map[e+1][l]<<4,l<maze.w-1&&(y|=maze.map[e][l+1]<<2,g|=maze.map[e+1][l+1]<<3)):e==maze.h-1&&(l>0&&(y|=maze.map[e][l-1]<<6,g|=maze.map[e-1][l-1]<<7),y|=maze.map[e-1][l],l<maze.w-1&&(g|=maze.map[e-1][l+1]<<1,y|=maze.map[e][l+1]<<2)),e>0&&e<maze.h-1&&l>0&&l<maze.w-1&&(y|=maze.map[e-1][l],g|=maze.map[e-1][l+1]<<1,y|=maze.map[e][l+1]<<2,g|=maze.map[e+1][l+1]<<3,y|=maze.map[e+1][l]<<4,g|=maze.map[e+1][l-1]<<5,y|=maze.map[e][l-1]<<6,g|=maze.map[e-1][l-1]<<7);var v="";0!=g?v+=0==y?g:y:0!=y&&(v+=y);var x=null;u[v]&&(x=new PIXI.Sprite(resources[u[v].src].texture),x.position.x=16*l+8,x.position.y=16*e+8,x.anchor.x=.5,x.anchor.y=.5,x.rotation=u[v].rot*Math.PI/180,container.addChild(x))}filtermat=[],filtermat[0]=[4,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0],filtermat[1]=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],filtermat[3]=[20,-4,-1,0,0,5,1,4,0,0,7,-2,-1,0,0,0,10,9,14,0],filtermat[4]=[10,0,0,0,0,0,1,0,0,0,0,0,8,0,0,0,0,0,1,0],filtermat[5]=[2,0,0,0,0,0,10,0,0,0,0,0,.5,0,0,0,0,0,1,0],filtermat[2]=[4,0,0,0,0,0,.5,0,0,0,0,0,.5,0,0,0,0,0,1,0],filtermat[6]=[8,0,0,0,0,0,.5,0,0,0,0,0,2,0,0,0,0,0,1,0],filtermat[7]=[.5,0,0,0,0,0,8,0,0,0,0,0,.5,0,0,0,0,0,1,0],filtermat[8]=[4,0,0,0,0,0,-1,0,0,0,0,0,.5,0,0,0,0,0,1,0],mazefilter.matrix=filtermat[random(0,filtermat.length)].slice(),state=play,gameloop()}function stopMusic(){for(var e in buzz.sounds)buzz.sounds[e].mute()}function startMusic(){for(var e in buzz.sounds)buzz.sounds[e].unmute()}function pauseGame(){0==paused_game&&(paused_game=!0,fundal.pause(),alarm.pause(),fundal_pause.play())}function unpauseGame(){1==paused_game&&(fundal_pause.stop(),paused_game=!1,fundal.isPaused()&&fundal.play(),alarm.isPaused()&&alarm.play())}function gameloop(){requestAnimationFrame(gameloop),now=Date.now(),delta=now-then,delta>interval&&(then=now-delta%interval,paused_timer++,paused_timer>5*fps&&1==paused&&(paused=!1,paused_timer=0),state(),draw())}function draw(){if(1!=paused&&1!=paused_game){player.x-=12,player.y-=12,graphics.clear(),graphics.beginFill(0,1),graphics.drawCircle(player.x+20,player.y+20,18),graphics.endFill();for(var e=0;4>e;e++){ghosts[e].sprite.x-=12,ghosts[e].sprite.y-=12;var t=ghosts[e].mask;t.clear(),t.beginFill(0,1),t.drawCircle(ghosts[e].sprite.x+20,ghosts[e].sprite.y+20,18),t.endFill()}scoretext.text=10*score+"\nScore",leveltext.text=" LEVEL "+level+" LIVES "+lives,starttext.text=Math.round(gametimer/fps),0==gametimer?starttext.visible=!1:starttext.visible=!0,renderer.render(stage),player.x+=12,player.y+=12;for(var e=0;4>e;e++)ghosts[e].sprite.x+=12,ghosts[e].sprite.y+=12}}function play(){if(1!=paused&&1!=paused_game){if(gametimer>0)return void gametimer--;updatePlayer();for(var e=!1,t=0;4>t;t++)"STATE_FRIGHTENED"==ghosts[t].state&&(e=!0);e||(alarm.stop(),sound_intro.isEnded()&&lives>0&&fundal.play()),updateGhosts(),next_level()}}function updateGhosts(){filter1.matrix=[1,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,1,0],filter2.matrix=[3,0,0,0,0,0,1,0,0,0,0,0,3,0,0,0,0,0,1,0],filter3.matrix=[0,0,0,0,0,0,1,0,0,0,0,0,4,0,0,0,0,0,1,0],filter4.matrix=[2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0];for(var e=[updateRedGhost,updatePinkGhost,updateBlueGhost,updateOrangeGhost],t=0;4>t;t++)e[t](),ghosts[t].timer++,0==ghosts[t].die&&("STATE_FRIGHTENED"==ghosts[t].state?(ghosts[t].sprite.x+=2*ghosts[t].sprite.vx,ghosts[t].sprite.y+=2*ghosts[t].sprite.vy):(ghosts[t].sprite.x+=4*ghosts[t].sprite.vx,ghosts[t].sprite.y+=4*ghosts[t].sprite.vy))}function kill_ghost(e,t){return player.x>=e.sprite.x&&player.x<e.sprite.x+16&&player.y>=e.sprite.y&&player.y<e.sprite.y+16?(sound_eat_ghost.play(),e.die=!0,e.state="STATE_REVIVE",e.timer=0,score+=3,void t(e)):void(e.state="STATE_FRIGHTENED")}function revive(e,t){e.sprite.y=e.starty,e.sprite.x=e.startx,e.sprite.vx=0,e.sprite.vy=0,e.queue=[0,0,0,0],e.sprite.visible=!0,e.timer>e.startTimer?(e.sprite.y=160,e.sprite.x=240,e.state="STATE_SCATTER",e.timer=0,e.die=!1):e.state="STATE_REVIVE",t(e)}function kill_player(){for(var e=0;4>e;e++)if("STATE_FRIGHTENED"!=ghosts[e].state&&"STATE_REVIVE"!=ghosts[e].state&&player.x>=ghosts[e].sprite.x&&player.x<ghosts[e].sprite.x+16&&player.y>=ghosts[e].sprite.y&&player.y<ghosts[e].sprite.y+16){alarm.stop(),fundal.stop(),sound_death.play();for(var t=0;4>t;t++)ghosts[t].die=!0,ghosts[t].state="STATE_REVIVE",ghosts[t].timer=0;lives--,player.x=232,player.y=256,player.vx=-1,player.vy=0,player.timer=2*fps;var a=ghosts[e].name,r={name:a};return $.ajax({url:"gametweet",type:"POST",data:r,success:function(e){},error:function(){console.log("error ajax")}}),void(lives>0&&(gametimer=3*fps,sound_intro.play()))}}function stateFrightened(e,t){count+=.5;var a=e.sprite.vx,r=e.sprite.vy,s=Math.floor(e.sprite.x/16),i=Math.floor(e.sprite.y/16),o=e.sprite.x%16,p=e.sprite.y%16;if(0==p&&0==o){var n=maze.map[i][s-1],l=maze.map[i][s+1],h=maze.map[i-1][s],m=maze.map[i+1][s],d=[h,l,m,n],f=[-1,0,1,0],c=[0,1,0,-1],u=n+l,y=h+m;if((0==maze.map[i][s-1]||0==maze.map[i][s+1])&&(a=0),(0==maze.map[i-1][s]||0==maze.map[i+1][s])&&(r=0),0==a&&0==r||u>=1&&y>=1){for(var g=0;4>g;g++)e.queue[g]<0&&(e.queue[g]=0),e.queue[g]>10&&(e.queue[g]=10);for(var v,x=0,T=random(0,4),_=[T,T+1,T+2,T+3],g=0;4>g;g++)_[g]=_[g]%4;for(v=0;4>v;v++)if(1==d[_[v]]&&random(0,100)<=100-10*e.queue[_[v]]){var E=_[v];e.sprite.vx=c[E],e.sprite.vy=f[E],e.queue[E]+=8,e.queue[(E+2)%4]+=8,x=E;break}if(4==v)for(v=3;v>=0;v--)if(1==d[v]){e.sprite.vx=c[v],e.sprite.vy=f[v],x=v;break}for(v=0;4>v;v++)v!=x&&v!=(x+2)%4&&(e.queue[v]-=8)}}t(e)}function updateRedGhost(){var e=ghosts[0],t=e.state,a=e.sprite.vx,r=e.sprite.vy;switch(t){case"STATE_NONE":e.sprite.y=160,e.sprite.x=256,e.sprite.vx=0,e.sprite.vy=0,e.queue=[0,0,0,0],nextState="STATE_SCATTER",e.timer=0;break;case"STATE_REVIVE":revive(e,function(e){ghosts[0]=e}),nextState=e.state;break;case"STATE_SCATTER":stateFrightened(e,function(e){ghosts[0]=e});var s=e.sprite.x%16,i=e.sprite.y%16;e.timer>=fps*e.scatter_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_CHASE"):nextState="STATE_SCATTER";break;case"STATE_FRIGHTENED":kill_ghost(e,function(e){ghosts[0]=e}),stateFrightened(e,function(e){ghosts[0]=e});var o=filter1.matrix;o[1]=3*Math.sin(count),o[2]=Math.cos(count),o[3]=1.5*Math.cos(count),o[4]=2*Math.sin(count/3),o[5]=Math.sin(count/2),o[6]=Math.sin(count/4);var s=e.sprite.x%16,i=e.sprite.y%16;e.timer>=fps*e.scared_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_CHASE"):nextState=e.state;break;case"STATE_CHASE":nextState="STATE_CHASE";var p=Math.floor(e.sprite.x/16),n=Math.floor(e.sprite.y/16),s=e.sprite.x%16,i=e.sprite.y%16,l=Math.floor(player.x/16),h=Math.floor(player.y/16),a=e.sprite.vx,r=e.sprite.vy;if(0==i&&0==s){var m=maze.map[n][p-1],d=maze.map[n][p+1],f=maze.map[n-1][p],c=maze.map[n+1][p],u=m+d,y=f+c;(0==a&&0==r||u>=1&&y>=1)&&(p!=l||n!=h?bfs(p,n,l,h,function(t){if(t.length>0){var a=t[0];a.x-e.sprite.x!=0&&(e.sprite.vx=a.x-p),a.y-e.sprite.y!=0&&(e.sprite.vy=a.y-n),0!=e.sprite.vx&&(e.sprite.vx/=Math.abs(e.sprite.vx)),0!=e.sprite.vy&&(e.sprite.vy/=Math.abs(e.sprite.vy))}}):(e.sprite.vx=0,e.sprite.vy=0)),e.timer>=fps*e.chase_timer&&(e.timer=0,nextState="STATE_CHASE")}break;default:nextState="STATE_CHASE"}e.state=nextState}function updatePinkGhost(){var e=ghosts[1],t=e.state,a=e.sprite.vx,r=e.sprite.vy;switch(t){case"STATE_NONE":e.sprite.y=208,e.sprite.x=224,e.sprite.vx=0,e.sprite.vy=0,e.queue=[0,0,0,0],e.timer=0,score>0?(e.sprite.y=160,e.sprite.x=224,nextState="STATE_SCATTER"):nextState="STATE_NONE";break;case"STATE_REVIVE":revive(e,function(e){ghosts[1]=e}),nextState=e.state;break;case"STATE_SCATTER":stateFrightened(e,function(e){ghosts[1]=e});var s=e.sprite.x%16,i=e.sprite.y%16;e.timer>=fps*e.scatter_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_CHASE"):nextState="STATE_SCATTER";break;case"STATE_FRIGHTENED":kill_ghost(e,function(e){ghosts[1]=e}),stateFrightened(e,function(e){ghosts[1]=e});var s=e.sprite.x%16,i=e.sprite.y%16,o=filter2.matrix;o[1]=3*Math.sin(count),o[2]=Math.cos(count),o[3]=1.5*Math.cos(count),o[4]=2*Math.sin(count/3),o[5]=Math.sin(count/2),o[6]=Math.sin(count/4),e.timer>=fps*e.scared_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_SCATTER"):nextState=e.state;break;case"STATE_CHASE":nextState="STATE_CHASE";var p=Math.floor(e.sprite.x/16),n=Math.floor(e.sprite.y/16),s=e.sprite.x%16,i=e.sprite.y%16,l=Math.floor(player.x/16),h=Math.floor(player.y/16),a=e.sprite.vx,r=e.sprite.vy;if(0==i&&0==s){var m=maze.map[n][p-1],d=maze.map[n][p+1],f=maze.map[n-1][p],c=maze.map[n+1][p],u=m+d,y=f+c;if(0==a&&0==r||u>=1&&y>=1)if(p!=l||n!=h){var g=0,v=0;if(0!=player.vx){for(;1==maze.map[h][l+g*player.vx]&&(g++,6!=g););g-=2}if(0!=player.vy){for(;1==maze.map[h+v*player.vy][l]&&(v++,6!=v););v-=2}g>4&&(g=4),v>4&&(v=4),0>g&&(g=0),0>v&&(v=0),bfs(p,n,l+g*player.vx,h+v*player.vy,function(t){if(t.length>0){var a=t[0];a.x-e.sprite.x!=0&&(e.sprite.vx=a.x-p),a.y-e.sprite.y!=0&&(e.sprite.vy=a.y-n),0!=e.sprite.vx&&(e.sprite.vx/=Math.abs(e.sprite.vx)),0!=e.sprite.vy&&(e.sprite.vy/=Math.abs(e.sprite.vy))}})}else e.sprite.vx=0,e.sprite.vy=0;e.timer>=fps*e.chase_timer&&(e.timer=0,nextState="STATE_SCATTER")}break;default:nextState="STATE_CHASE"}e.state=nextState}function updateBlueGhost(){var e=ghosts[2],t=e.state,a=e.sprite.vx,r=e.sprite.vy;switch(t){case"STATE_NONE":e.sprite.y=208,e.sprite.x=208,e.sprite.vx=0,e.sprite.vy=0,e.queue=[0,0,0,0],e.timer=0,eaten_pills>container_pill.children.length/10?(e.sprite.y=160,e.sprite.x=208,nextState="STATE_SCATTER"):nextState="STATE_NONE";break;case"STATE_REVIVE":revive(e,function(e){ghosts[2]=e}),nextState=e.state;break;case"STATE_SCATTER":stateFrightened(e,function(e){ghosts[2]=e});var s=e.sprite.x%16,i=e.sprite.y%16;e.timer>=fps*e.scatter_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_CHASE"):nextState="STATE_SCATTER";break;case"STATE_FRIGHTENED":kill_ghost(e,function(e){ghosts[2]=e}),stateFrightened(e,function(e){ghosts[2]=e});var s=e.sprite.x%16,i=e.sprite.y%16,o=filter3.matrix;o[1]=3*Math.sin(count),o[2]=Math.cos(count),o[3]=1.5*Math.cos(count),o[4]=2*Math.sin(count/3),o[5]=Math.sin(count/2),o[6]=Math.sin(count/4),e.timer>=fps*e.scared_timer&&0==s&&0==i?(e.timer=0,nextState="STATE_SCATTER"):nextState=e.state;break;case"STATE_CHASE":nextState="STATE_CHASE";var p=Math.floor(e.sprite.x/16),n=Math.floor(e.sprite.y/16),s=e.sprite.x%16,i=e.sprite.y%16,l=Math.floor(player.x/16),h=Math.floor(player.y/16),a=e.sprite.vx,r=e.sprite.vy;if(0==i&&0==s){var m=maze.map[n][p-1],d=maze.map[n][p+1],f=maze.map[n-1][p],c=maze.map[n+1][p],u=m+d,y=f+c;(0==a&&0==r||u>=1&&y>=1)&&(p!=l||n!=h?bfs(p,n,l,h,function(t){if(t.length>0){var a=t[0];a.x-e.sprite.x!=0&&(e.sprite.vx=a.x-p),a.y-e.sprite.y!=0&&(e.sprite.vy=a.y-n),0!=e.sprite.vx&&(e.sprite.vx/=Math.abs(e.sprite.vx)),0!=e.sprite.vy&&(e.sprite.vy/=Math.abs(e.sprite.vy))}}):(e.sprite.vx=0,e.sprite.vy=0)),e.timer>=fps*e.chase_timer&&(e.timer=0,nextState="STATE_SCATTER")}break;default:nextState="STATE_CHASE"}e.state=nextState}function updateOrangeGhost(){var e=ghosts[3],t=e.state,a=e.sprite.vx,r=e.sprite.vy;switch(t){case"STATE_NONE":e.sprite.y=208,e.sprite.x=256,e.sprite.vx=0,e.sprite.vy=0,e.queue=[0,0,0,0],e.timer=0,eaten_pills>container_pill.children.length/5?(e.sprite.y=160,e.sprite.x=256,nextState="STATE_SCATTER"):nextState="STATE_NONE";break;case"STATE_REVIVE":revive(e,function(e){ghosts[3]=e}),nextState=e.state;break;case"STATE_SCATTER":stateFrightened(e,function(e){ghosts[3]=e});var s=Math.floor(player.x/16),i=Math.floor(player.y/16),o=Math.floor(e.sprite.x/16),p=Math.floor(e.sprite.y/16),n=e.sprite.x%16,l=e.sprite.y%16;if(0==n&&0==l){var h=Math.sqrt((s-o)*(s-o)+(i-p)*(i-p));h>8?nextState="STATE_CHASE":nextState="STATE_SCATTER"}else nextState="STATE_SCATTER";break;case"STATE_FRIGHTENED":kill_ghost(e,function(e){ghosts[3]=e}),stateFrightened(e,function(e){ghosts[3]=e});var n=e.sprite.x%16,l=e.sprite.y%16,m=filter4.matrix;m[1]=3*Math.sin(count),m[2]=Math.cos(count),m[3]=1.5*Math.cos(count),m[4]=2*Math.sin(count/3),m[5]=Math.sin(count/2),m[6]=Math.sin(count/4),e.timer>=fps*e.scared_timer&&0==n&&0==l?(e.timer=0,nextState="STATE_SCATTER"):nextState=e.state;break;case"STATE_CHASE":nextState="STATE_CHASE";var o=Math.floor(e.sprite.x/16),p=Math.floor(e.sprite.y/16),n=e.sprite.x%16,l=e.sprite.y%16,s=Math.floor(player.x/16),i=Math.floor(player.y/16),a=e.sprite.vx,r=e.sprite.vy;if(0==n&&0==l){var h=Math.sqrt((s-o)*(s-o)+(i-p)*(i-p));h>8?nextState="STATE_CHASE":nextState="STATE_SCATTER"}else nextState="STATE_CHASE";if(0==l&&0==n){var d=maze.map[p][o-1],f=maze.map[p][o+1],c=maze.map[p-1][o],u=maze.map[p+1][o],y=d+f,g=c+u;(0==a&&0==r||y>=1&&g>=1)&&(o!=s||p!=i?bfs(o,p,s,i,function(t){if(t.length>0){var a=t[0];a.x-e.sprite.x!=0&&(e.sprite.vx=a.x-o),a.y-e.sprite.y!=0&&(e.sprite.vy=a.y-p),0!=e.sprite.vx&&(e.sprite.vx/=Math.abs(e.sprite.vx)),0!=e.sprite.vy&&(e.sprite.vy/=Math.abs(e.sprite.vy))}}):(e.sprite.vx=0,e.sprite.vy=0))}break;default:nextState="STATE_CHASE"}e.state=nextState}function updatePlayer(){if(player.timer>0)return void player.timer--;kill_player(),player.width=16,player.height=16;var e=player_dir,t=Math.floor(player.x/16),a=Math.floor(player.y/16),r=player.x%16,s=player.y%16;player.vx,player.vy;if(0==s&&0==r)switch((0==maze.map[a][t-1]||0==maze.map[a][t+1])&&(player.vx=0),(0==maze.map[a-1][t]||0==maze.map[a+1][t])&&(player.vy=0),e){case UP:0==maze.map[a-1][t]?player.vy=0:(player.vy=-1,player.vx=0);break;case RIGHT:0==maze.map[a][t+1]?player.vx=0:(player.vx=1,player.vy=0);break;case DOWN:0==maze.map[a+1][t]?player.vy=0:(player.vy=1,player.vx=0);break;case LEFT:0==maze.map[a][t-1]?player.vx=0:(player.vx=-1,player.vy=0)}for(var i=container_pill.children.length-1;i>=0;i--){var o=hitTestRectangle(player,container_pill.children[i]);if(o.hit&&1==container_pill.children[i].visible)if(eaten_pills++,container_pill.children[i].visible=!1,-1!=pills_bonus.indexOf(container_pill.children[i])){score+=2,sound_bonus.play(),alarm.play();for(var p=0;4>p;p++)"STATE_NONE"!=ghosts[p].state&&"STATE_REVIVE"!=ghosts[p].state&&(ghosts[p].state="STATE_FRIGHTENED",ghosts[p].timer=0)}else score+=1,sound_eat_pill.play()}player.x+=4*player.vx,player.y+=4*player.vy,player.width=40,player.height=70}function bfs(e,t,a,r,s){var i,o=[],p={};p.x=e,p.y=t;for(var n=[],l=[],i=0;i<maze.h;i++){l[i]=[];for(var h=0;h<maze.w;h++)l[i][h]=0}for(var i=0;i<maze.h;i++){n[i]=[];for(var h=0;h<maze.w;h++)n[i][h]=0}var o=[];o.push(p);for(var i=0;i<maze.h;i++)n[i][0]=n[i][maze.w-1]=-1;for(var i=0;i<maze.w;i++)n[0][i]=n[maze.h-1][i]=-1;for(var m=[-1,0,1,0],d=[0,1,0,-1];o.length>0;)for(var f=o.shift(),c=0;4>c;c++){var u=f.y+m[c],y=f.x+d[c],g={};if(g.x=y,g.y=u,y>0&&u>0&&y<maze.w&&u<maze.h&&1==maze.map[u][y]&&0==n[u][y]&&(o.push(g),n[u][y]=n[f.y][f.x]+1,l[u][y]=f,y==a&&u==r)){var v=[],x={};for(x.x=g.x,x.y=g.y;x.x!=e||x.y!=t;)v.push(x),x=l[x.y][x.x];s(v.reverse())}}}function hitTestRectangle(e,t){var a,r,s,i,o,p={hit:!1,vx:0,vy:0};return a=!1,e.centerX=e.x+e.width/2,e.centerY=e.y+e.height/2,t.centerX=t.x+t.width/2,t.centerY=t.y+t.height/2,e.halfWidth=e.width/2,e.halfHeight=e.height/2,t.halfWidth=t.width/2,t.halfHeight=t.height/2,i=e.centerX-t.centerX,o=e.centerY-t.centerY,r=e.halfWidth+t.halfWidth,s=e.halfHeight+t.halfHeight,Math.abs(i)<r&&Math.abs(o)<s?(p.vx=i,p.vy=o,a=!0):a=!1,p.hit=a,p}function random(e,t){return Math.floor(e+Math.random()*(t-e))}function keyboard(e){var t={};return t.code=e,t.isDown=!1,t.isUp=!0,t.press=void 0,t.release=void 0,t.downHandler=function(e){e.keyCode===t.code&&(t.isUp&&t.press&&t.press(),t.isDown=!0,t.isUp=!1),e.preventDefault()},t.upHandler=function(e){e.keyCode===t.code&&(t.isDown&&t.release&&t.release(),t.isDown=!1,t.isUp=!0),e.preventDefault()},window.addEventListener("keydown",t.downHandler.bind(t),!1),window.addEventListener("keyup",t.upHandler.bind(t),!1),t}function touchXY(e){var t=e.touches[0].pageX-renderer.view.offsetLeft,a=e.touches[0].pageY-renderer.view.offsetTop,r=renderer.view.clientWidth,s=renderer.view.clientHeight;t/=r/480,a/=s/640,t-=player.x,a-=player.y;var i=1,o=0,p=t*i+a*o,n=Math.sqrt(t*t+a*a),l=Math.sqrt(i*i+o*o),h=p/(n*l),m=Math.acos(h),d=180*m/Math.PI;a>0&&(d=360-d),d>45&&135>d?player_dir=UP:315>=d&&d>225&&(player_dir=DOWN),45>=d||d>315?player_dir=RIGHT:225>=d&&d>=135&&(player_dir=LEFT)}window.onload=load_game;var resources=PIXI.loader.resources,stage=new PIXI.Container,renderer=PIXI.autoDetectRenderer(480,640,{backgroundColor:0});document.getElementById("game-view").appendChild(renderer.view),stage.interactive=!0;const UP=0,RIGHT=1,DOWN=2,LEFT=3,NONE=4;var container,graphics,player,player_dir,container_pill,bounds,pills_bonus=[],eaten_pills=0,filter1=new PIXI.filters.ColorMatrixFilter,filter2=new PIXI.filters.ColorMatrixFilter,filter3=new PIXI.filters.ColorMatrixFilter,filter4=new PIXI.filters.ColorMatrixFilter,mazefilter=new PIXI.filters.ColorMatrixFilter,count=0,fps=30,now,then=Date.now(),interval=1e3/fps,delta,gametimer=3*fps,paused_timer=0,paused=!1,paused_game=!1,scoretext=new PIXI.Text("COUNT 4EVAR: 0",{font:"bold 14px ArcadeRounded,Helvetica,Arial,sans-serif",align:"right",fill:"#fff"});scoretext.position.x=400,scoretext.position.y=490,scoretext.anchor.x=0;var leveltext=new PIXI.Text("COUNT 4EVAR: 0",{font:"bold 14px ArcadeRounded,Helvetica,Arial,sans-serif",fill:"#fff"});leveltext.position.x=0,leveltext.position.y=490,leveltext.anchor.x=0;var starttext=new PIXI.Text("COUNT 4EVAR: 0",{font:"bold 24px ArcadeRounded,Helvetica,Arial,sans-serif",fill:"#fff"});starttext.position.x=230,starttext.position.y=300,starttext.anchor.x=0;var maze={},ghosts,level=1,score=0,lives=3,player_image="",sound_intro=new buzz.sound("sounds/pacman_intro.wav",{}),sound_eat_pill=new buzz.sound("/sounds/pill.mp3",{});sound_eat_pill.setSpeed(2),sound_eat_pill.setVolume(50);var sound_bonus=new buzz.sound("/sounds/powerpill.mp3",{}),sound_eat_ghost=new buzz.sound("/sounds/pacman_eatghost.wav",{}),sound_death=new buzz.sound("/sounds/pacman_death.wav",{}),fundal=new buzz.sound("/sounds/fundal.mp3",{loop:!0}),fundal_pause=new buzz.sound("/sounds/pause.mp3",{loop:!0});fundal_pause.setVolume(30);var alarm=new buzz.sound("/sounds/pacman_alarm.wav",{loop:!0});alarm.setVolume(100);var tile=new PIXI.Sprite;window.addEventListener("touchstart",function(e){touchXY(e)},!1),window.addEventListener("touchmove",function(e){touchXY(e)},!1);